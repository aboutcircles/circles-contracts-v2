<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Architectural Overview - Circles Protocol</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Architectural Overview";
        var mkdocs_page_input_path = "architecture.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Circles Protocol
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../about/">About</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../introduction/">Introduction</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Architectural Overview</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#system-architecture-diagram">System Architecture Diagram</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#core-components">Core Components</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#hub-v2-circles">Hub v2 (Circles)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#nameregistry">NameRegistry</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#migration">Migration</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#groups-policies-and-treasury">Groups, Policies and Treasury</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#groups">Groups</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#standard-treasury">Standard Treasury</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#vaults">Vaults</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#base-mint-policy">Base Mint Policy</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#system-interaction">System Interaction</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#token-representations">Token Representations</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#circles-erc1155">Circles (ERC1155)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#wrappers">Wrappers</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#erc20lift">ERC20Lift</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#circles-v1-components-legacy">Circles v1 Components (Legacy)</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#hub-v1">Hub v1</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#token">Token</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#external-interactions">External Interactions</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#gnosis-chain">Gnosis Chain</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#safe">Safe</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#eoa-externally-owned-accounts">EoA (Externally Owned Accounts)</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#advanced-features-and-extensions">Advanced Features and Extensions</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#intent-solver-competition">Intent Solver Competition</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#pre-post-hooks-on-intents">Pre-/Post-hooks on Intents</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#flow-matrix-and-erc1155">Flow Matrix and ERC1155</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#single-transferthrough-for-v1-pathfinder">Single TransferThrough for v1 Pathfinder</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#account-abstraction">Account Abstraction</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#custom-treasuries">Custom Treasuries</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#community-dapps">Community dApps</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#conclusion">Conclusion</a>
    </li>
    </ul>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Advanced Topics</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../advanced-topics/inflation-demurrage/">Inflation and Demurrage</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../advanced-topics/path-based-transactions/">Path-based Transactions</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Circles Protocol</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Architectural Overview</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="circles-architectural-overview">Circles Architectural Overview</h1>
<h2 id="introduction">Introduction</h2>
<p>Circles is a decentralized economic system built on the Gnosis Chain, designed to create and distribute fair and social money through personal currencies. This overview provides a high-level understanding of the system's architecture and how its various components interact.</p>
<h2 id="system-architecture-diagram">System Architecture Diagram</h2>
<p><img alt="Alt text" src="../20240321-Circles-contracts.svg" /></p>
<p><a href="https://link.excalidraw.com/readonly/EuVbVxV3LE0AZ3Od5rpP" target="_blank" rel="noopener noreferrer">
  Open Circles Architecture diagram in new tab
</a></p>
<h2 id="core-components">Core Components</h2>
<h3 id="hub-v2-circles">Hub v2 (Circles)</h3>
<p>The central contract in the Circles ecosystem is the Hub v2, which serves as the main entry point for interactions with the system. It manages:</p>
<ul>
<li>Registration of humans, organizations, and groups</li>
<li>Minting of personal currencies</li>
<li>Trust relationships between entities</li>
<li>Group creation and management</li>
<li>Minting collateral into group currencies</li>
<li>Wrapping ERC1155 Circles Ids tokens into ERC20 wrappers</li>
<li>Demurrage of all Circles tokens equally </li>
</ul>
<p>The Hub v2 contract implements the ERC1155 standard, allowing it to handle multiple token types efficiently.</p>
<p><a href="https://github.com/aboutcircles/circles-contracts-v2/blob/v0.3.6-docs/src/hub/Hub.sol">Code: /src/hub/Hub.sol</a></p>
<h3 id="nameregistry">NameRegistry</h3>
<p>The NameRegistry contract manages names, symbols and metadata for avatars (humans, groups, and organizations):</p>
<ul>
<li>Allows humans to register a unique short name (12 characters, base58 encoding)</li>
<li>Stores custom names for groups and organizations</li>
<li>Manages custom symbols for group currencies</li>
<li>Stores and updates metadata digests (eg IPFS CIDs) for avatar profiles</li>
<li>Names are read by ERC20 contracts for name and symbol</li>
</ul>
<p>The NameRegistry plays a role in identity management and human-readable addressing within the Circles system, enhancing user experience and facilitating easier identification of avatars and their associated currencies.</p>
<p><a href="https://github.com/aboutcircles/circles-contracts-v2/blob/v0.3.6-docs/src/names/NameRegistry.sol">Code: /src/names/NameRegistry.sol</a></p>
<h3 id="migration">Migration</h3>
<p>The Migration contract facilitates the transition from Circles v1 to v2, ensuring the ability to migrate token balances:</p>
<ul>
<li>Converts v1 Circles to v2 Circles, accounting for inflation and demurrage</li>
<li>Uses a linear interpolation method to calculate the conversion rate. Corrects for the original convention in hub v1 where 1/3 CRC per hour is issued (8 CRC per day)</li>
<li>Allows migration of multiple types of Circles balances in a single transaction by one owner</li>
<li>Locks v1 tokens in the Migration contract and mints equivalent v2 tokens.</li>
<li>Ensures upon migrating balances that humans are auto-registered in Hub v2 - so that their token is defined</li>
<li>owners of Circles in v1 can migrate their balances at any time and for any amount they chose to Circles v2.</li>
</ul>
<p>This Migration system ensures a controlled and secure transition from Circles v1 to v2, maintaining integrity throughout the upgrade process.</p>
<p><a href="https://github.com/aboutcircles/circles-contracts-v2/blob/v0.3.6-docs/src/migration/Migration.sol">Code: /src/migration/Migration.sol</a></p>
<h3 id="groups-policies-and-treasury">Groups, Policies and Treasury</h3>
<p>Circles allows the definition of group currencies, which involves several interconnected components:</p>
<h4 id="groups">Groups</h4>
<ul>
<li>Defined in the Hub contract</li>
<li>Require a Mint Policy and Treasury for creation</li>
<li>Can be registered using <code>hub.registerGroup()</code></li>
</ul>
<h4 id="standard-treasury">Standard Treasury</h4>
<ol>
<li><strong>Purpose</strong>: Manages collateral for group currencies</li>
<li><strong>Key Features</strong>:</li>
<li>Acts as a factory for Vaults</li>
<li>Handles minting and redemption of group Circles</li>
<li>Interacts with Mint Policies for redemption logic</li>
<li><strong>Functions</strong>:</li>
<li><code>onERC1155Received</code>: Handles single token transfers (minting or redemption)</li>
<li><code>onERC1155BatchReceived</code>: Handles batch token transfers (minting)</li>
<li>Creates Vaults for groups as needed</li>
</ol>
<h4 id="vaults">Vaults</h4>
<ol>
<li><strong>Purpose</strong>: Securely store collateral for group currencies</li>
<li><strong>Key Features</strong>:</li>
<li>Deployed by Standard Treasury using a factory pattern</li>
<li>Each group has its own Vault</li>
<li><strong>Functions</strong>:</li>
<li><code>returnCollateral</code>: Sends collateral back to users during redemption</li>
<li><code>burnCollateral</code>: Burns collateral as specified by Mint Policy</li>
</ol>
<h4 id="base-mint-policy">Base Mint Policy</h4>
<ol>
<li><strong>Purpose</strong>: Defines rules for minting, burning, and redeeming group currencies</li>
<li><strong>Key Features</strong>:</li>
<li>Customizable for different group needs</li>
<li>Default implementation allows all mints/burns and user-specified redemptions</li>
<li><strong>Functions</strong>:</li>
<li><code>beforeMintPolicy</code>: Validates minting requests</li>
<li><code>beforeBurnPolicy</code>: Validates burning requests</li>
<li><code>beforeRedeemPolicy</code>: Specifies redemption logic</li>
</ol>
<h4 id="system-interaction">System Interaction</h4>
<ol>
<li><strong>Group Creation</strong>:</li>
<li>User calls <code>hub.registerGroup()</code></li>
<li>Hub assigns Standard Treasury</li>
<li>
<p>Standard Treasury creates a Vault for the group</p>
</li>
<li>
<p><strong>Minting Group Circles</strong>:</p>
</li>
<li>Collateral transferred to Treasury</li>
<li>Treasury forwards collateral to group's Vault</li>
<li>Mint Policy consulted for approval</li>
<li>
<p>Group Circles minted to user</p>
</li>
<li>
<p><strong>Redeeming Group Circles</strong>:</p>
</li>
<li>User sends group Circles to Treasury</li>
<li>Treasury consults Mint Policy for redemption logic</li>
<li>Vault returns specified collateral to user</li>
<li>Excess collateral burned if specified by policy</li>
</ol>
<p>This system provides a flexible and secure framework for creating and managing group currencies within the Circles ecosystem. It allows for customizable minting and redemption policies while ensuring proper collateralization and secure storage of assets.</p>
<h2 id="token-representations">Token Representations</h2>
<h3 id="circles-erc1155">Circles (ERC1155)</h3>
<p>The core representation of Circles currencies uses the ERC1155 standard, allowing for efficient management of multiple token types (personal and group currencies) within a single contract.</p>
<h3 id="wrappers">Wrappers</h3>
<p>To enhance compatibility with existing DeFi ecosystems, Circles provides ERC20 wrappers:</p>
<ol>
<li><strong>Demurrage ERC20</strong>: Represents Circles with the demurrage (decay) factor applied.</li>
<li><strong>Inflationary ERC20</strong>: Represents Circles in their inflationary form, without demurrage applied.</li>
</ol>
<h3 id="erc20lift">ERC20Lift</h3>
<p>The ERC20Lift contract serves as a bridge between the ERC1155 and ERC20 representations, allowing users to wrap and unwrap their Circles tokens as needed.</p>
<h2 id="circles-v1-components-legacy">Circles v1 Components (Legacy)</h2>
<h3 id="hub-v1">Hub v1</h3>
<p>The original Hub contract from Circles v1, which is being phased out but remains relevant for migration purposes.</p>
<h3 id="token">Token</h3>
<p>The individual ERC20 token contracts for personal currencies in Circles v1.</p>
<h2 id="external-interactions">External Interactions</h2>
<h3 id="gnosis-chain">Gnosis Chain</h3>
<p>Circles is built on the Gnosis Chain, leveraging its security and efficiency.</p>
<h3 id="safe">Safe</h3>
<p>Integration with Safe (formerly Gnosis Safe) provides secure multi-signature wallet functionality for Circles users.</p>
<h3 id="eoa-externally-owned-accounts">EoA (Externally Owned Accounts)</h3>
<p>Standard Ethereum accounts that can interact with the Circles system.</p>
<h2 id="advanced-features-and-extensions">Advanced Features and Extensions</h2>
<h3 id="intent-solver-competition">Intent Solver Competition</h3>
<p>(Placeholder) A mechanism for optimizing transactions and transfers within the Circles network.</p>
<h3 id="pre-post-hooks-on-intents">Pre-/Post-hooks on Intents</h3>
<p>(Placeholder) Additional logic that can be executed before or after certain operations in the system.</p>
<h3 id="flow-matrix-and-erc1155">Flow Matrix and ERC1155</h3>
<p>A system for managing and executing complex transfers and exchanges of Circles currencies between multiple parties.</p>
<h3 id="single-transferthrough-for-v1-pathfinder">Single TransferThrough for v1 Pathfinder</h3>
<p>A mechanism to facilitate transfers using trust pathways, likely a carryover or adaptation from the v1 system.</p>
<h3 id="account-abstraction">Account Abstraction</h3>
<p>(Placeholder) Advanced account management features that may simplify user interactions with the system.</p>
<h3 id="custom-treasuries">Custom Treasuries</h3>
<p>In addition to the Standard Treasury, the system allows for custom treasury implementations to cater to specific group needs.</p>
<h3 id="community-dapps">Community dApps</h3>
<p>The architecture supports the development of community-driven decentralized applications, such as a potential CowSwap v2 integration.</p>
<h2 id="conclusion">Conclusion</h2>
<p>The Circles v2 architecture represents a significant evolution from its predecessor, offering a more flexible and scalable system for personal and group currencies. By leveraging advanced smart contract standards like ERC1155 and providing multiple token representations, Circles aims to create a robust ecosystem for social money that can integrate seamlessly with the broader DeFi landscape.</p>
<p>This architecture balances the need for a cohesive, centralized hub with the flexibility required for diverse use cases and future extensions. As the system continues to evolve, this modular design will allow for the integration of new features and improvements while maintaining backward compatibility and supporting the migration from v1.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../introduction/" class="btn btn-neutral float-left" title="Introduction"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../advanced-topics/inflation-demurrage/" class="btn btn-neutral float-right" title="Inflation and Demurrage">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../introduction/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../advanced-topics/inflation-demurrage/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
